<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v7.0 - ç‡ˆè™Ÿå®Œç¾æ ¡æ­£ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* === UI æ¨£å¼å®Œå…¨é‚„åŸ === */
        body, html { margin: 0; padding: 0; height: 100%; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        
        .season-tabs { display: flex; gap: 2px; margin: 10px 0; background: #e2e8f0; padding: 3px; border-radius: 6px; }
        .season-tab { flex: 1; padding: 8px 5px; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 4px; color: #4a5568; transition: 0.3s; }
        .season-tab.active { background: #c53030; color: white; }

        .custom-marker { display: flex; align-items: center; justify-content: center; border: 2px solid black; border-radius: 50%; color: black; font-weight: bold; font-size: 13px; box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center; transform-origin: center !important; }
        .bg-pink { background-color: #ff69b4 !important; }
        .bg-blue { background-color: #87ceeb !important; }
        .bg-green { background-color: #00BB00 !important; }
        .bg-grey { background-color: #8E8E8E !important; }
        .bg-white { background-color: #E0E0E0 !important; }
        .bg-gold { background-color: #ffd700 !important; }
        .bg-purple { background-color: #BE77FF !important; }
        .bg-brown { background-color: #8b4513 !important; color: white !important; }

        .highlight-marker { width: 48px !important; height: 48px !important; margin-left: -24px !important; margin-top: -24px !important; z-index: 999 !important; border: 3px solid gold !important; box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8) !important; transition: all 0.3s ease; }
        
        /* å‹•æ…‹ç‡ˆè™Ÿå‹•ç•« */
        @keyframes pulse-ring { 
            0% { transform: scale(0.8); opacity: 0.8; } 
            100% { transform: scale(1.8); opacity: 0; } 
        }
        
        /* ä¿®å¾©ä½ç§»ï¼šç§»é™¤æœ¬é«” borderï¼Œæ”¹ç”¨å½å…ƒç´ è£½ä½œç´”å‹•ç•«åœˆ */
        .today-active, .future-active { z-index: 1000 !important; }
        
        .today-active:after { 
            content: ''; position: absolute; inset: -3px; 
            border-radius: 50%; border: 3px solid red; 
            animation: pulse-ring 2s infinite; pointer-events: none; 
        }
        
        .future-active:after { 
            content: ''; position: absolute; inset: -3px; 
            border-radius: 50%; border: 3px solid orange; 
            animation: pulse-ring 2s infinite; pointer-events: none; 
        }

        #stat-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 280px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        #march-calc-panel { position: absolute; top: 60px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border-top: 5px solid #c53030; }
        
        .calc-h { margin: 0 0 10px 0; font-size: 15px; font-weight: bold; color: #333; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .calc-row { margin-bottom: 8px; }
        .calc-row label { display: block; font-size: 11px; color: #666; margin-bottom: 2px; }
        .calc-in-group { display: flex; gap: 4px; }
        .calc-in-group input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
        #btn-march-calc { width: 100%; padding: 7px; background: #c53030; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        #march-result { margin-top: 10px; padding: 8px; background: #fff5f5; border-radius: 4px; font-size: 12px; line-height: 1.5; border: 1px dashed #feb2b2; display: none; }

        .stat-item { font-size: 13px; margin: 5px 0; padding: 10px 8px; border-bottom: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
        .stat-item:hover { background: rgba(0,0,0,0.05); }
        .city-link { color: #1a73e8; font-weight: bold; }

        .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 5px; }
        .toolbar button { padding: 8px 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #admin-btn.logged-in { background: #2e7d32; }

        .gate-tag { background: #eee; padding: 2px 6px; border-radius: 3px; font-size: 11px; color: #333; border: 1px solid #ccc; }
        .history-list { margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px; max-height: 120px; overflow-y: auto; }
        .history-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #666; background: #f9f9f9; margin-bottom: 2px; padding: 2px 4px; border-radius: 2px; }
        .del-history-btn { cursor: pointer; color: #d32f2f; margin-left: 8px; font-weight: bold; padding: 0 4px; border: 1px solid transparent; border-radius: 3px; }
        .del-history-btn:hover { border-color: #d32f2f; background: #fff; }
    </style>
</head>
<body>

<div id="stat-panel">
    <h3 style="margin:0 0 10px 0;">å…¬æœƒéœ¸æ¥­ç©åˆ†æ’è¡Œ <span id="season-label" style="font-size:12px; color:#c53030;">S3</span></h3>
    <div class="season-tabs">
        <div class="season-tab" id="tab-s1" onclick="window.switchSeason('s1')">ç¬¬ä¸€å­£</div>
        <div class="season-tab" id="tab-s2" onclick="window.switchSeason('s2')">ç¬¬äºŒå­£</div>
        <div class="season-tab active" id="tab-s3" onclick="window.switchSeason('s3')">ç¬¬ä¸‰å­£</div>
    </div>
    <select id="guild-filter" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;"><option value="">è¼‰å…¥ä¸­...</option></select>
    <div id="stat-content">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹è©³æƒ…</div>
</div>

<div id="march-calc-panel">
    <div class="calc-h">ğŸ¹ å·®ä¸å¤šè¡Œè»æ™‚é–“è¨ˆç®—</div>
    <div class="calc-row"><label>èµ·é» (X, Y)</label><div class="calc-in-group"><input type="number" id="m_x1" placeholder="X"><input type="number" id="m_y1" placeholder="Y"></div></div>
    <div class="calc-row"><label>çµ‚é» (X, Y)</label><div class="calc-in-group"><input type="number" id="m_x2" placeholder="X"><input type="number" id="m_y2" placeholder="Y"></div></div>
    <button id="btn-march-calc">é–‹å§‹è¨ˆç®—</button>
    <div id="march-result"></div>
</div>

<div class="toolbar">
    <button id="admin-btn">ğŸ”“ ç®¡ç†å“¡ç™»å…¥</button>
    <button id="export-btn" style="display:none;">ğŸ’¾ å‚™ä»½æ•¸æ“š</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable",
        storageBucket: "revelation-sandtable.firebasestorage.app",
        messagingSenderId: "572907835922",
        appId: "1:572907835922:web:505556c77ea56cfac83ecb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentSeason = 's3';
    let isAdmin = false;
    const ADMIN_PASSWORD = "wu0 u86";
    let markersData = [];
    let guildHistory = [];
    let markerInstances = [];

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
    const bounds = [[0, 0], [2973, 2978]];
    L.imageOverlay('https://drive.google.com/thumbnail?id=1MK2MEVjV1uaiDsTNigi5oUEyAJusPpuN&sz=w2973', bounds).addTo(map);
    map.fitBounds(bounds);

    window.switchSeason = function(sId) {
        if (window.currentRef) off(window.currentRef);
        currentSeason = sId;
        window.currentRef = ref(db, `season_data/${sId}`);
        document.querySelectorAll('.season-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${sId}`).classList.add('active');
        document.getElementById('season-label').innerText = sId.toUpperCase();

        onValue(window.currentRef, (snapshot) => {
            const data = snapshot.val();
            markersData = data ? (data.markers || []) : [];
            guildHistory = data ? (data.guilds || []) : [];
            refreshMap();
            updateDropdown();
            updateStats();
        });
    };

    function refreshMap() {
        markerInstances.forEach(m => { if(m) map.removeLayer(m); });
        markerInstances = [];

        const today = new Date(); 
        today.setHours(0,0,0,0);
        const todayStr = today.toISOString().split('T')[0];
        
        const hasToday = markersData.some(d => d.date === todayStr);
        let targetEffectDate = todayStr;
        let isFutureType = false;

        if (!hasToday) {
            let futureDates = markersData
                .filter(d => d.date && new Date(d.date) > today)
                .map(d => d.date)
                .sort();
            if (futureDates.length > 0) {
                targetEffectDate = futureDates[0];
                isFutureType = true;
            }
        }

        markersData.forEach((d, i) => {
            let effectClass = "";
            if (d.date === targetEffectDate && d.date !== "") {
                effectClass = isFutureType ? "future-active" : "today-active";
            }

            const icon = L.divIcon({
                className: `custom-marker ${d.color} ${effectClass}`,
                html: `<span>${d.guild ? d.guild.slice(0, 2) : '?'}</span>`,
                iconSize: [34, 34], iconAnchor: [17, 17]
            });
            const m = L.marker(d.latlng, { icon, draggable: isAdmin }).addTo(map);

            m.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                if (isAdmin) {
                    openForm(e.target.getLatLng(), i);
                } else {
                    let historyHtml = "";
                    if (d.history && d.history.length > 0) {
                        historyHtml = `<div class="history-list"><strong>ğŸ“œ æ­·å²ç´€éŒ„ï¼š</strong>`;
                        [...d.history].reverse().slice(0, 5).forEach(h => {
                            historyHtml += `<div class="history-row"><span>${h.guild}</span><span>${h.date}</span></div>`;
                        });
                        historyHtml += `</div>`;
                    }

                    L.popup({ minWidth: 600 }).setLatLng(e.target.getLatLng()).setContent(`
                        <div style="display: flex; gap: 20px; font-family: 'Microsoft JhengHei'; padding: 5px;">
                            <div style="flex: 0 0 300px; height: 200px; background: #222; border-radius: 6px; overflow: hidden; border: 1px solid #ddd;">
                                <img src="${d.city}.png" 
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#aaa; line-height:200px; text-align:center;\'>ğŸ° æš«ç„¡åœ–ç‰‡</div>';" 
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="flex: 1;">
                                <div style="border-bottom: 2px solid #c53030; padding-bottom: 5px; margin-bottom: 10px;">
                                    <strong style="font-size:18px;">${d.city}</strong>
                                </div>
                                <div style="font-size: 14px; line-height: 1.8;">
                                    <b>ä½”é ˜å…¬æœƒï¼š</b>${d.guild || 'ç„¡'}<br>
                                    <b>åŸæ± ç­‰ç´šï¼š</b>Lv.${d.level || 1} (${d.score || 0}åˆ†)<br>
                                    <b>é–‹æ”¾æ—¥æœŸï¼š</b>${d.date || 'æœªè¨­å®š'}<br>
                                    ${d.gate ? `<span class="gate-tag">ğŸ“ ${d.gate}</span>` : ''}
                                </div>
                                ${historyHtml}
                            </div>
                        </div>
                    `).openOn(map);
                }
            });

            m.on('dragend', (e) => { if (isAdmin) { markersData[i].latlng = e.target.getLatLng(); saveToCloud(); } });
            markerInstances[i] = m;
        });
    }

    map.on('contextmenu', (e) => { if (isAdmin) openForm(e.latlng); });

    function openForm(latlng, index = null) {
        const isEdit = index !== null;
        let d = isEdit ? JSON.parse(JSON.stringify(markersData[index])) : { city: '', guild: '', color: 'bg-pink', level: 1, date: '', gate: '', history: [] };
        
        let gateOptions = '<option value="">-- ç„¡æˆ°ç•¥é» --</option>';
        for(let i=1; i<=8; i++){ const val = `${i}è™Ÿé–€`; gateOptions += `<option value="${val}" ${d.gate === val ? 'selected' : ''}>${val}</option>`; }

        let historyEditHtml = "";
        if (isEdit && d.history && d.history.length > 0) {
            historyEditHtml = `<div class="history-list"><strong>ç®¡ç†ç´€éŒ„ (é»æ“ŠâŒåˆªé™¤)ï¼š</strong>`;
            d.history.forEach((h, hIdx) => {
                historyEditHtml += `
                    <div class="history-row">
                        <span>${h.guild} (${h.date})</span>
                        <span class="del-history-btn" onclick="window.removeHistory(${index}, ${hIdx})">âŒ</span>
                    </div>`;
            });
            historyEditHtml += `</div>`;
        }

        const html = `
            <div class="popup-form" style="display:flex; flex-direction:column; gap:8px; min-width:210px; padding:5px;">
                <strong style="text-align:center; border-bottom:1px solid #ddd; padding-bottom:5px;">${isEdit ? 'ç·¨è¼¯' : 'æ–°å¢'}åŸæ± </strong>
                <input type="text" id="f_city" value="${d.city}" placeholder="åŸæ± åç¨±" style="padding:6px;">
                <input type="text" id="f_guild" list="guild_list" value="${d.guild}" placeholder="ä½”é ˜å…¬æœƒ" style="padding:6px;">
                <datalist id="guild_list">${guildHistory.map(g => `<option value="${g}">`).join('')}</datalist>
                <input type="date" id="f_date" value="${d.date || ''}" style="padding:6px;">
                <select id="f_gate" style="padding:6px;">${gateOptions}</select>
                <input type="number" id="f_level" value="${d.level}" placeholder="ç­‰ç´š" style="padding:6px;">
                <select id="f_color" style="padding:6px;">
                    <option value="bg-pink" ${d.color==='bg-pink'?'selected':''}>å°æœå…¬æœƒ</option>
                    <option value="bg-blue" ${d.color==='bg-blue'?'selected':''}>éŸ“æœå…¬æœƒ</option>
                    <option value="bg-green" ${d.color==='bg-green'?'selected':''}>æ—¥æœå…¬æœƒ</option>
                    <option value="bg-grey" ${d.color==='bg-grey'?'selected':''}>ç©ºåŸ</option>
                    <option value="bg-white" ${d.color==='bg-white'?'selected':''}>å°šæœªé–‹æ”¾</option>
                    <option value="bg-gold" ${d.color==='bg-gold'?'selected':''}>å¤©æ¶¯</option>
                    <option value="bg-purple" ${d.color==='bg-purple'?'selected':''}>æš®è‰²</option>
                    <option value="bg-brown" ${d.color==='bg-brown'?'selected':''}>ç‹—å¤§ä¾¿è‰²</option>
                </select>
                ${historyEditHtml}
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button id="pop-save" style="flex:2; padding:10px; background:#2e7d32; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">å„²å­˜</button>
                    ${isEdit ? `<button id="pop-del" style="flex:1; padding:10px; background:#d32f2f; color:white; border:none; border-radius:4px; cursor:pointer;">åˆªé™¤</button>` : ''}
                </div>
            </div>`;

        L.popup({ minWidth: 220 }).setLatLng(latlng).setContent(html).openOn(map);

        document.getElementById('pop-save').onclick = () => {
            const newGuild = document.getElementById('f_guild').value;
            let history = d.history || [];
            if (isEdit && markersData[index].guild && markersData[index].guild !== newGuild) {
                history.push({ guild: markersData[index].guild, date: markersData[index].date || 'ç„¡æ—¥æœŸ' });
            }
            const newData = {
                city: document.getElementById('f_city').value || 'æœªå‘½å',
                guild: newGuild,
                date: document.getElementById('f_date').value,
                gate: document.getElementById('f_gate').value,
                level: parseInt(document.getElementById('f_level').value) || 1,
                score: (parseInt(document.getElementById('f_level').value) || 1) * 20,
                color: document.getElementById('f_color').value,
                latlng: { lat: latlng.lat, lng: latlng.lng },
                history: history
            };
            if (newGuild && !guildHistory.includes(newGuild)) guildHistory.push(newGuild);
            if (isEdit) markersData[index] = newData; else markersData.push(newData);
            saveToCloud(); map.closePopup();
        };
        if(isEdit) document.getElementById('pop-del').onclick = () => { if(confirm('åˆªé™¤æ¨™è¨˜ï¼Ÿ')) { markersData.splice(index, 1); saveToCloud(); map.closePopup(); } };
    }

    window.removeHistory = (mIdx, hIdx) => {
        if(confirm("ç¢ºå®šåˆªé™¤é€™æ¢æ­·å²ç´€éŒ„ï¼Ÿ")) {
            markersData[mIdx].history.splice(hIdx, 1);
            saveToCloud();
            openForm(markersData[mIdx].latlng, mIdx);
        }
    };

    function saveToCloud() { if (isAdmin) set(window.currentRef, { markers: markersData, guilds: guildHistory }); }

    const adminBtn = document.getElementById('admin-btn');
    const exportBtn = document.getElementById('export-btn');

    adminBtn.onclick = () => {
        if (!isAdmin) {
            const pass = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                adminBtn.innerText = "ğŸ”’ é€€å‡ºç®¡ç†";
                adminBtn.classList.add('logged-in');
                exportBtn.style.display = "block";
                refreshMap();
            }
        } else {
            isAdmin = false;
            adminBtn.innerText = "ğŸ”“ ç®¡ç†å“¡ç™»å…¥";
            adminBtn.classList.remove('logged-in');
            exportBtn.style.display = "none";
            refreshMap();
        }
    };

    document.getElementById('btn-march-calc').onclick = () => {
        const x1 = parseInt(document.getElementById('m_x1').value), y1 = parseInt(document.getElementById('m_y1').value);
        const x2 = parseInt(document.getElementById('m_x2').value), y2 = parseInt(document.getElementById('m_y2').value);
        if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) return;
        let distance = Math.abs(x1 - x2) + Math.abs(y1 - y2) - 1;
        const totalSec = Math.max(0, distance * 4);
        const h = Math.floor(totalSec / 3600), m = Math.floor((totalSec % 3600) / 60), s = totalSec % 60;
        const res = document.getElementById('march-result');
        res.style.display = 'block';
        res.innerHTML = `è€—æ™‚ï¼š<b style="color:#c53030; font-size:14px;">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</b>`;
    };

    function updateDropdown() {
        const sel = document.getElementById('guild-filter');
        const current = sel.value;
        const scores = {};
        markersData.forEach(m => { if (m.guild && m.color !== 'bg-white') scores[m.guild] = (scores[m.guild] || 0) + (m.score || 0); });
        const sorted = Object.keys(scores).sort((a, b) => scores[b] - scores[a]);
        sel.innerHTML = '<option value="">é¸æ“‡å…¬æœƒ...</option>' + sorted.map((g, i) => `<option value="${g}" ${g===current?'selected':''}>Top ${i+1} | ${g} (${scores[g]}åˆ†)</option>`).join('');
    }

    function updateStats() {
        const guild = document.getElementById('guild-filter').value;
        const content = document.getElementById('stat-content');
        markerInstances.forEach(m => { if(m) { const el = m.getElement(); if(el) el.classList.remove('highlight-marker'); } });
        if (!guild) { content.innerHTML = '<div style="color:#999; text-align:center;">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹è©³æƒ…</div>'; return; }
        const mine = markersData.map((m, idx) => ({...m, idx})).filter(m => m.guild === guild);
        let total = 0;
        let html = `<div style="padding-bottom:10px; border-bottom:1px solid #eee; margin-bottom:10px;"><b style="font-size:16px;">${guild}</b></div>`;
        mine.forEach(m => {
            if (markerInstances[m.idx]) { const el = markerInstances[m.idx].getElement(); if(el) el.classList.add('highlight-marker'); }
            html += `<div class="stat-item" onclick="window.jumpToMarker(${m.idx})">
                        <div style="display:flex; justify-content:space-between;"><span class="city-link">ğŸ° ${m.city}</span><b style="color:#d32f2f;">${m.score}</b></div>
                        <div style="font-size:11px; color:#666; margin-top:4px;">Lv.${m.level} | ${m.date || 'ç„¡æ—¥æœŸ'}</div>
                    </div>`;
            total += m.score;
        });
        html += `<div style="margin-top:10px; padding:10px; background:#fef3c7; border-radius:5px; font-weight:bold; color:#92400e;">ç¸½ç©åˆ†ï¼š${total}</div>`;
        content.innerHTML = html;
    }

    window.jumpToMarker = (idx) => {
        const d = markersData[idx];
        if (d) { map.flyTo(d.latlng, 1); setTimeout(() => markerInstances[idx].fire('click'), 500); }
    };

    document.getElementById('guild-filter').onchange = updateStats;
    exportBtn.onclick = () => {
        const blob = new Blob([JSON.stringify({ markers: markersData, guilds: guildHistory })], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æ²™ç›¤å‚™ä»½_${currentSeason}.json`; a.click();
    };

    window.switchSeason('s3');
</script>
</body>
</html>
