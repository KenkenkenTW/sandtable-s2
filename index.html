<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v6.2 - æ¨™è¨˜å…¬æœƒæ’å</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        
        /* åŸºç¤æ¨™è¨˜ */
        .custom-marker { 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid black; border-radius: 50%; 
            color: black; font-weight: bold; font-size: 13px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center;
            transform-origin: center !important;
        }
        
        .bg-pink { background-color: #ff69b4 !important; }
        .bg-blue { background-color: #87ceeb !important; }
        .bg-green { background-color: #00BB00 !important; }
        .bg-grey { background-color: #8E8E8E !important; }
        .bg-white { background-color: #E0E0E0 !important; }
        .bg-gold { background-color: #ffd700 !important; }
        .bg-purple { background-color: #BE77FF !important; }
        .bg-brown { background-color: #8b4513 !important; color: white !important; }
      
        /* è¢«é¸ä¸­å…¬æœƒçš„æ¨™è¨˜çªé¡¯æ¨£å¼ */
        .highlight-marker {
            width: 48px !important; height: 48px !important;
            margin-left: -24px !important; margin-top: -24px !important;
            z-index: 999 !important; border: 3px solid gold !important;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8) !important;
            transition: all 0.3s ease;
        }
        .highlight-marker span { font-size: 16px !important; }

        /* ç‰¹æ•ˆé—œéµå½±æ ¼ */
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        @keyframes pulse-orange {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 165, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); }
        }

        /* ç‹€æ…‹é¡å */
        .today-active { z-index: 1000 !important; border: 3px solid red !important; }
        .today-active:after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 3px solid red; animation: pulse-red 2s infinite; pointer-events: none; box-sizing: border-box;
        }

        .future-active { z-index: 999 !important; border: 3px solid orange !important; }
        .future-active:after {
            content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 3px solid orange; animation: pulse-orange 2s infinite; pointer-events: none; box-sizing: border-box;
        }

        /* UI é¢æ¿ - å·¦å´æ’è¡Œ */
        #stat-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 260px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        
        /* UI é¢æ¿ - å³å´è¡Œè»è¨ˆç®—å™¨ */
        #march-calc-panel { position: absolute; top: 60px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border-top: 5px solid #c53030; }
        .calc-h { margin: 0 0 10px 0; font-size: 15px; color: #333; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .calc-row { margin-bottom: 8px; }
        .calc-row label { display: block; font-size: 11px; color: #666; }
        .calc-in-group { display: flex; gap: 4px; }
        .calc-in-group input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
        #btn-march-calc { width: 100%; padding: 7px; background: #c53030; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        #march-result { margin-top: 10px; padding: 8px; background: #fff5f5; border-radius: 4px; font-size: 12px; line-height: 1.5; border: 1px dashed #feb2b2; display: none; }

        .stat-item { font-size: 13px; margin: 5px 0; padding: 10px 8px; border-bottom: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
        .stat-item:hover { background: rgba(0,0,0,0.05); }
        .city-link { color: #1a73e8; font-weight: bold; }
        
        .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 5px; }
        .toolbar button { padding: 8px 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #admin-btn { background: #d32f2f; }
        #admin-btn.logged-in { background: #2e7d32; }

        .popup-form { display: flex; flex-direction: column; gap: 8px; min-width: 220px; padding: 5px; }
        .popup-form input, .popup-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-save { background: #2e7d32; color: white; border: none; padding: 10px; cursor: pointer; flex: 2; border-radius: 4px; }
        .btn-del { background: #d32f2f; color: white; border: none; padding: 10px; cursor: pointer; flex: 1; border-radius: 4px; }
        
        .hint { position: absolute; bottom: 15px; left: 15px; z-index: 1000; color: white; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
        .sync-status { color: #4caf50; font-size: 10px; margin-top: 5px; text-align: right; }
        .gate-tag { background: #eee; padding: 2px 5px; border-radius: 3px; font-size: 10px; color: #333; border: 1px solid #ccc; font-weight: normal; }
      
    /* ... ä¿ç•™æ‚¨åŸæœ‰çš„ CSS ... */

    /* æ–°å¢æ’åæ¨™ç±¤æ¨£å¼ */
    .rank-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        color: white;
        margin-right: 5px;
        vertical-align: middle;
    }
    .rank-1 { background-color: #d4af37; border: 1px solid #b8860b; } /* é‡‘ */
    .rank-2 { background-color: #aaa9ad; border: 1px solid #7d7d7d; } /* éŠ€ */
    .rank-3 { background-color: #cd7f32; border: 1px solid #8b4513; } /* éŠ… */
    .rank-other { background-color: #4a5568; } /* å…¶ä»– */

    /* èª¿æ•´ä¸‹æ‹‰é¸å–®æ¨£å¼ä»¥ç¬¦åˆè¦–è¦º */
    #guild-filter {
        background-color: #fff;
        font-weight: bold;
        color: #333;
    }
 
    </style>
</head>
<body>

<div id="stat-panel">
    <h3 style="margin-top:0;">å…¬æœƒå‹¢åŠ›æ’è¡Œ</h3>
    <select id="guild-filter" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;">
        <option value="">è¨ˆç®—ç©åˆ†ä¸­...</option>
    </select>
    <div id="stat-content">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹è©³æƒ…</div>
    <div class="sync-status" id="status-text">â— é›²ç«¯é€£ç·šä¸­</div>
</div>

<div id="march-calc-panel">
    <div class="calc-h">ğŸ¹ è¡Œè»æ™‚é–“è¨ˆç®—</div>
    <div class="calc-row">
        <label>èµ·é» (X, Y)</label>
        <div class="calc-in-group">
            <input type="number" id="m_x1" placeholder="X">
            <input type="number" id="m_y1" placeholder="Y">
        </div>
    </div>
    <div class="calc-row">
        <label>çµ‚é» (X, Y)</label>
        <div class="calc-in-group">
            <input type="number" id="m_x2" placeholder="X">
            <input type="number" id="m_y2" placeholder="Y">
        </div>
    </div>
    <button id="btn-march-calc">é–‹å§‹è¨ˆç®—</button>
    <div id="march-result"></div>
</div>

<div class="toolbar">
    <button id="admin-btn">ğŸ”“ ç®¡ç†å“¡ç™»å…¥</button>
    <button id="export-btn" style="display:none;">ğŸ’¾ å‚™ä»½æ•¸æ“š</button>
</div>

<div class="hint" id="action-hint">ç´…è‰²é–ƒçˆï¼šä»Šæ—¥é–‹æ”¾ | æ©˜è‰²é–ƒçˆï¼šä¸‹æ¬¡é å‘Š</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase é…ç½® (èˆ‡ 6.0 ç›¸åŒ)
    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable",
        storageBucket: "revelation-sandtable.firebasestorage.app",
        messagingSenderId: "572907835922",
        appId: "1:572907835922:web:505556c77ea56cfac83ecb",
        measurementId: "G-3K2YS695G9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const cloudRef = ref(db, 'war_map_data');

    let isAdmin = false;
    const ADMIN_PASSWORD = "wu0 u86"; 

    let markersData = [];
    let guildHistory = [];
    let markerInstances = [];

    const imgUrl = 'https://drive.google.com/thumbnail?id=1MK2MEVjV1uaiDsTNigi5oUEyAJusPpuN&sz=w2973';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
    const bounds = [[0, 0], [2973, 2978]]; 
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // --- è¡Œè»è¨ˆç®—é‚è¼¯ ---
    document.getElementById('btn-march-calc').onclick = () => {
        const x1 = parseInt(document.getElementById('m_x1').value);
        const y1 = parseInt(document.getElementById('m_y1').value);
        const x2 = parseInt(document.getElementById('m_x2').value);
        const y2 = parseInt(document.getElementById('m_y2').value);

        if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) {
            alert("è«‹å®Œæ•´è¼¸å…¥èµ·é»èˆ‡çµ‚é»åº§æ¨™"); return;
        }

        // è·é›¢å…¬å¼: ABS(x1-x2) + ABS(y1-y2) - 1
        let distance = Math.abs(x1 - x2) + Math.abs(y1 - y2) - 1;
        if (distance < 0) distance = 0; // èµ·çµ‚é»ç›¸åŒæ™‚è¨­ç‚º0

        // æ™‚é–“è¨ˆç®—: è·é›¢ * 4 ç§’
        const totalSec = distance * 4;
        
        // æ ¼å¼åŒ– hh:mm:ss
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        const timeStr = [h, m, s].map(v => String(v).padStart(2, '0')).join(':');

        const resDiv = document.getElementById('march-result');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `è€—æ™‚ï¼š<b style="color:#c53030; font-size:14px;">${timeStr}</b>`;
    };

    // --- ä»¥ä¸‹ç‚º v6.0 åŸæœ‰é‚è¼¯ ---

    const adminBtn = document.getElementById('admin-btn');
    const exportBtn = document.getElementById('export-btn');
    adminBtn.onclick = () => {
        if (!isAdmin) {
            const pass = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                adminBtn.innerText = "ğŸ”’ é€€å‡ºç®¡ç†";
                adminBtn.classList.add('logged-in');
                exportBtn.style.display = "block";
                refreshMap();
            }
        } else {
            isAdmin = false;
            adminBtn.innerText = "ğŸ”“ ç®¡ç†å“¡ç™»å…¥";
            adminBtn.classList.remove('logged-in');
            exportBtn.style.display = "none";
            refreshMap();
        }
    };

    onValue(cloudRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            markersData = data.markers || [];
            guildHistory = data.guilds || [];
            refreshMap();
            updateDropdown();
            updateStats();
            document.getElementById('status-text').innerText = "â— é›²ç«¯å·²åŒæ­¥";
        }
    });

    function refreshMap() {
        markerInstances.forEach(m => { if(m) map.removeLayer(m); });
        markerInstances = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        const hasToday = markersData.some(d => d.date === todayStr);
        let targetEffectDate = todayStr;
        let isFutureType = false;
        if (!hasToday) {
            let closestFuture = null;
            markersData.forEach(d => {
                if (d.date) {
                    const dDate = new Date(d.date);
                    dDate.setHours(0, 0, 0, 0);
                    if (dDate > today) {
                        if (!closestFuture || dDate < closestFuture) closestFuture = dDate;
                    }
                }
            });
            if (closestFuture) {
                targetEffectDate = `${closestFuture.getFullYear()}-${String(closestFuture.getMonth()+1).padStart(2,'0')}-${String(closestFuture.getDate()).padStart(2,'0')}`;
                isFutureType = true;
            }
        }
        markersData.forEach((d, i) => renderMarker(d, i, targetEffectDate, isFutureType));
    }

    function renderMarker(d, i, targetEffectDate, isFutureType) {
        const todayStr = new Date().toISOString().split('T')[0];
        let effectClass = "";
        if (d.date === targetEffectDate && d.date !== "") {
            effectClass = isFutureType ? "future-active" : "today-active";
        }
        const displayName = d.guild ? d.guild.slice(0, 2) : '?';
        const icon = L.divIcon({
            className: `custom-marker ${d.color} ${effectClass}`,
            html: `<span>${displayName}</span>`,
            iconSize: [34, 34],
            iconAnchor: [17, 17]
        });
        const m = L.marker(d.latlng, { icon, draggable: isAdmin }).addTo(map);
        m.on('click', (e) => { 
            L.DomEvent.stopPropagation(e); 
            if (isAdmin) openForm(e.target.getLatLng(), i); 
            else {
                const dateInfo = d.date ? d.date : 'æœªè¨­å®š';
                let todayTag = "";
                if (d.date === todayStr) {
                    todayTag = '<span style="color:red; font-weight:bold; font-size:12px; display:block; margin-top:5px;">ğŸ”¥ ä»Šæ—¥é–‹æ”¾</span>';
                } else if (isFutureType && d.date === targetEffectDate) {
                    todayTag = '<span style="color:orange; font-weight:bold; font-size:12px; display:block; margin-top:5px;">ğŸ•’ ä¸‹æ¬¡é–‹æ”¾é å‘Š</span>';
                }
                const gateInfo = d.gate ? `<br><b>ğŸ“ å°ˆå±¬æˆ°ç•¥é»ï¼š</b><span style="color:#d32f2f;">${d.gate}</span>` : '';
                L.popup({ minWidth: 673, maxWidth: 800 }).setLatLng(e.target.getLatLng()).setContent(`
                    <div style="display: flex; align-items: stretch; gap: 20px; font-family: 'Microsoft JhengHei'; padding: 5px;">
                        <div style="flex: 0 0 453px; width: 453px; height: 308px; background: #222; border-radius: 6px; overflow: hidden; border: 1px solid #ddd;">
                            <img src="${d.city}.png" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#aaa; line-height:308px; text-align:center;\'>ğŸ° æš«ç„¡åœ–ç‰‡</div>';" style="width: 453px; height: 308px; object-fit: cover; display: block;">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 180px;">
                            <div style="border-bottom: 2px solid #1a73e8; padding-bottom: 8px; margin-bottom: 12px;">
                                <strong style="font-size:20px; color:#333;">${d.city}</strong>${todayTag}
                            </div>
                            <div style="font-size: 14px; line-height: 2; color: #444;">
                                <b>ä½”é ˜å…¬æœƒï¼š</b><br><span style="font-size:16px; color:#000;">${d.guild || 'ç„¡'}</span>${gateInfo}<br>
                                <hr style="margin: 10px 0; border: 0; border-top: 1px dashed #ccc;">
                                <b>ä½”é ˜æ—¥æœŸï¼š</b>${dateInfo}<br>
                                <b>åŸæ± ç­‰ç´šï¼š</b><span style="color:#1a73e8; font-weight:bold; font-size:16px;">Lv.${d.level || 1}</span>
                            </div>
                        </div>
                    </div>
                `).openOn(map);
            }
        });
        m.on('dragend', (e) => { if (isAdmin) { markersData[i].latlng = e.target.getLatLng(); pushToCloud(); } });
        markerInstances[i] = m;
    }

    window.jumpToMarker = function(index) {
        const data = markersData[index];
        const marker = markerInstances[index];
        if (data && marker) {
            map.flyTo(data.latlng, 1, { duration: 1.2 });
            setTimeout(() => { marker.fire('click'); }, 1300);
        }
    };

    map.on('contextmenu', (e) => { if (isAdmin) openForm(e.latlng); });

    function openForm(latlng, index = null) {
        const isEdit = index !== null;
        const d = isEdit ? markersData[index] : { city: '', guild: '', color: 'bg-pink', level: 1, date: '', gate: '' };
        const historyOptions = guildHistory.map(g => `<option value="${g}">`).join('');
        let gateOptions = '<option value="">-- ç„¡æˆ°ç•¥é» --</option>';
        for(let i=1; i<=8; i++){
            const val = `${i}è™Ÿé–€`;
            gateOptions += `<option value="${val}" ${d.gate === val ? 'selected' : ''}>${val}</option>`;
        }
        const html = `
            <div class="popup-form">
                <strong>${isEdit ? 'ç·¨è¼¯æ¨™è¨˜' : 'æ–°å¢æ¨™è¨˜'}</strong>
                <input type="text" id="f_city" value="${d.city}" placeholder="åŸæ± åç¨±">
                <input type="date" id="f_date" value="${d.date || ''}">
                <label style="font-size:12px; color:#666;">å°ˆå±¬æˆ°ç•¥é»ï¼š</label>
                <select id="f_gate">${gateOptions}</select>
                <input type="number" id="f_level" value="${d.level}" placeholder="ç­‰ç´š">
                <input type="text" id="f_guild" list="guild_list" value="${d.guild}" placeholder="ä½”é ˜å…¬æœƒ">
                <datalist id="guild_list">${historyOptions}</datalist>
                <select id="f_color">
                    <option value="bg-pink" ${d.color==='bg-pink'?'selected':''}>å°æœ</option>
                    <option value="bg-blue" ${d.color==='bg-blue'?'selected':''}>éŸ“æœ</option>
                    <option value="bg-green" ${d.color==='bg-green'?'selected':''}>æ—¥æœ</option>
                    <option value="bg-grey" ${d.color==='bg-grey'?'selected':''}>ç©ºåŸ</option>
                    <option value="bg-white" ${d.color==='bg-white'?'selected':''}>æœªé–‹æ”¾</option>
                    <option value="bg-gold" ${d.color==='bg-gold'?'selected':''}>é‡‘è‰²</option>
                    <option value="bg-purple" ${d.color==='bg-purple'?'selected':''}>ç´«è‰²</option>
                    <option value="bg-brown" ${d.color==='bg-brown'?'selected':''}>ç‹—è‰²</option>
                </select>
                <div class="btn-group">
                    <button class="btn-save" id="pop-save">å„²å­˜åŒæ­¥</button>
                    ${isEdit ? `<button class="btn-del" id="pop-del">åˆªé™¤</button>` : ''}
                </div>
            </div>`;
        L.popup({ minWidth: 230 }).setLatLng(latlng).setContent(html).openOn(map);
        document.getElementById('pop-save').onclick = () => {
            const guild = document.getElementById('f_guild').value;
            const level = parseInt(document.getElementById('f_level').value) || 1;
            const newData = {
                city: document.getElementById('f_city').value || 'æœªå‘½å',
                date: document.getElementById('f_date').value,
                gate: document.getElementById('f_gate').value,
                level: level, score: level * 20,
                guild: guild, color: document.getElementById('f_color').value,
                latlng: { lat: latlng.lat, lng: latlng.lng }
            };
            if (guild && !guildHistory.includes(guild)) guildHistory.push(guild);
            if (isEdit) markersData[index] = newData;
            else markersData.push(newData);
            pushToCloud();
            map.closePopup();
        };
        if(isEdit) {
            document.getElementById('pop-del').onclick = () => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                    markersData.splice(index, 1);
                    pushToCloud();
                    map.closePopup();
                }
            };
        }
    }

// --- ã€æ›´æ–°ç‰ˆã€‘è‡ªå‹•æ’åèˆ‡æ’é™¤æœªé–‹æ”¾é‚è¼¯ ---
    function updateDropdown() {
        const sel = document.getElementById('guild-filter');
        const current = sel.value;
        const guildScores = {};

        // 1. è¨ˆç®—ç©åˆ†ï¼ˆæ’é™¤é¡è‰²ç‚º bg-white æˆ–åç¨±å«"æœªé–‹æ”¾"çš„æ¨™è¨˜ï¼‰
        markersData.forEach(m => {
            const isUnopened = (m.color === 'bg-white' || (m.guild && m.guild.includes("æœªé–‹æ”¾")));
            if (m.guild && !isUnopened) {
                const score = parseInt(m.score) || 0;
                guildScores[m.guild] = (guildScores[m.guild] || 0) + score;
            }
        });

        // 2. ä¾ç…§ç¸½åˆ†å¾é«˜åˆ°ä½é€²è¡Œæ’åº
        const sortedGuilds = Object.keys(guildScores).sort((a, b) => guildScores[b] - guildScores[a]);

        // 3. æ³¨å…¥ä¸‹æ‹‰é¸å–®ï¼Œä¸¦åœ¨å‰æ–¹åŠ ä¸Š Top æ’å
        let options = '<option value="">é¸æ“‡å…¬æœƒ (ä¾æˆ°åŠ›æ’å)...</option>';
        sortedGuilds.forEach((g, index) => {
            const rank = index + 1;
            // åªæœ‰å‰ä¸‰ååŠ å€‹å°åœ–ç¤ºå¢åŠ è¾¨è­˜åº¦
            let medal = rank === 1 ? 'ğŸ¥‡ ' : (rank === 2 ? 'ğŸ¥ˆ ' : (rank === 3 ? 'ğŸ¥‰ ' : ''));
            options += `<option value="${g}" ${g === current ? 'selected' : ''}>${medal}Top ${rank} | ${g} (${guildScores[g]}åˆ†)</option>`;
        });
        
        sel.innerHTML = options;
        
        // å°‡æ’åºçµæœå­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œè®“ updateStats ä¹Ÿèƒ½é¡¯ç¤ºæ’åå¾½ç« 
        window.currentRankData = sortedGuilds;
    }

function updateStats() {
        const guild = document.getElementById('guild-filter').value;
        const content = document.getElementById('stat-content');
        
        // é‡ç½®åœ°åœ–æ¨™è¨˜çš„é«˜äº®
        markerInstances.forEach(m => { if (m) { const el = m.getElement(); if (el) el.classList.remove('highlight-marker'); } });
        
        if (!guild) { 
            content.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹å‹¢åŠ›ç¯„åœ</div>'; 
            return; 
        }

        // å–å¾—æ’åé †åº
        const rankIndex = window.currentRankData ? window.currentRankData.indexOf(guild) : -1;
        const rankDisplay = rankIndex !== -1 ? `<span style="background:#333; color:gold; padding:2px 6px; border-radius:4px; margin-right:8px; font-size:12px;">Top ${rankIndex + 1}</span>` : '';

        let mine = markersData.map((m, originalIdx) => ({...m, originalIdx})).filter(m => m.guild === guild);
        mine.sort((a, b) => { if (!a.date && !b.date) return 0; if (!a.date) return 1; if (!b.date) return -1; return new Date(a.date) - new Date(b.date); });
        
        let html = `<div style="padding-bottom:10px; border-bottom:1px solid #eee; margin-bottom:10px;">${rankDisplay}<b style="font-size:16px;">${guild}</b></div>`;
        let total = 0;
        
        mine.forEach(m => {
            const markerInstance = markerInstances[m.originalIdx];
            if (markerInstance) { const el = markerInstance.getElement(); if (el) el.classList.add('highlight-marker'); }
            const today = new Date().toISOString().split('T')[0];
            const dateStyle = m.date === today ? 'color: #d32f2f; font-weight: bold;' : 'color: #666;';
            
            html += `
                <div class="stat-item" onclick="jumpToMarker(${m.originalIdx})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="city-link">ğŸ° ${m.city}</span>
                        <b style="color:#d32f2f;">${m.score}</b>
                    </div>
                    <div style="font-size:11px; margin-top:4px;">
                        ${m.gate ? `<span class="gate-tag">ğŸ“ ${m.gate}</span> ` : ''}
                        <span style="${dateStyle}">ç­‰ç´š: Lv.${m.level} ${m.date ? `| ğŸ“… ${m.date}` : '| ğŸ“… æ—¥æœŸæœªå®š'}</span>
                    </div>
                </div>`;
            total += m.score;
        });
        
        html += `<div style="margin-top:15px; padding:12px; background:#fef3c7; border:1px solid #f59e0b; border-radius:6px; color:#92400e; font-weight:bold;">å…¬æœƒç¸½æˆ°ç•¥ç©åˆ†ï¼š<span style="float:right; font-size:1.1em;">${total}</span></div>`;
        content.innerHTML = html;
    }

    function pushToCloud() { if (!isAdmin) return; set(cloudRef, { markers: markersData, guilds: guildHistory }); }
    document.getElementById('guild-filter').onchange = updateStats;
    document.getElementById('export-btn').onclick = () => {
        const blob = new Blob([JSON.stringify({ markers: markersData, guilds: guildHistory })], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æ²™ç›¤å‚™ä»½_${new Date().toLocaleDateString()}.json`;
        a.click();
    };
</script>
</body>
</html>
