<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v5.2 - ç¸®æ”¾ç²¾ç¢ºå°é½Šç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: transparent; }
        
        /* ä¿®æ­£æ¨™è¨˜éŒ¨é»ï¼šiconSize ç‚º 36ï¼Œå‰‡ margin éœ€ç‚º -18 ç¢ºä¿ä¸­å¿ƒå°é½Š */
        .custom-marker { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid black; 
            border-radius: 50%; 
            color: black; 
            font-weight: bold; 
            font-size: 13px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5); 
            text-align: center;
            background-clip: padding-box;
        }
        
        /* å‹•æ…‹æ•ˆæœèˆ‡åº•è‰²ä¿æŒä¸è®Š */
        .bg-pink { background-color: #ff69b4 !important; }
        .bg-blue { background-color: #87ceeb !important; }
        .bg-green { background-color: #90ee90 !important; }
        .bg-grey { background-color: #8E8E8E !important; }
        .bg-white { background-color: #E0E0E0 !important; }
        .bg-gold { background-color: #ffd700 !important; }
        .bg-silver { background-color: #c0c0c0 !important; }
        .bg-brown { background-color: #8b4513 !important; color: white !important; }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.8); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .today-pulse { animation: pulse-red 2s infinite; border: 3px solid red !important; z-index: 1000 !important; }

        #stat-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; width: 260px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
        .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 5px; }
        .toolbar button { padding: 8px 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #admin-btn { background: #d32f2f; }
        #admin-btn.logged-in { background: #2e7d32; }
        .hint { position: absolute; bottom: 15px; left: 15px; z-index: 1000; color: white; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; font-size: 12px; }
    </style>
</head>
<body>

<div id="stat-panel">
    <h3>å…¬æœƒå‹¢åŠ›çµ±è¨ˆ</h3>
    <select id="guild-filter" style="width: 100%; padding: 8px; margin-bottom: 10px;">
        <option value="">é¸æ“‡å…¬æœƒ...</option>
    </select>
    <div id="stat-content">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹æˆ°ç¸¾</div>
</div>

<div class="toolbar">
    <button id="admin-btn">ğŸ”“ ç®¡ç†å“¡ç™»å…¥</button>
    <button id="export-btn" style="display:none;">ğŸ’¾ å‚™ä»½</button>
</div>

<div class="hint" id="action-hint">ç¸®æ”¾åŒæ­¥å·²æ ¡æ­£ | æ¨¡å¼ï¼šå”¯è®€</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable",
        storageBucket: "revelation-sandtable.firebasestorage.app",
        messagingSenderId: "572907835922",
        appId: "1:572907835922:web:505556c77ea56cfac83ecb",
        measurementId: "G-3K2YS695G9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const cloudRef = ref(db, 'war_map_data');

    // --- åœ°åœ–è¨­å®š (æ ¸å¿ƒä¿®æ­£è™•) ---
    const imgWidth = 2973;
    const imgHeight = 2978;
    const bounds = [[0, 0], [imgHeight, imgWidth]]; // åš´æ ¼å°æ‡‰åœ–ç‰‡å°ºå¯¸

    const map = L.map('map', {
        crs: L.CRS.Simple, // å¹³é¢åº§æ¨™
        minZoom: -1.5,
        maxZoom: 2,
        maxBounds: bounds, // é™åˆ¶åœ°åœ–ä¸èƒ½æ»‘å‡ºé‚Šç•Œ
        maxBoundsViscosity: 1.0
    });

    const imgUrl = 'é–‹å­£.png';
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // --- å…¶é¤˜é‚è¼¯ä¿æŒåŒæ­¥ ---
    let isAdmin = false;
    const ADMIN_PASSWORD = "wu0 u86"; 
    let markersData = [];
    let guildHistory = [];
    let markerInstances = [];

    const adminBtn = document.getElementById('admin-btn');
    const exportBtn = document.getElementById('export-btn');

    adminBtn.onclick = () => {
        if (!isAdmin) {
            const pass = prompt("å¯†ç¢¼ï¼š");
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                adminBtn.innerText = "ğŸ”’ é€€å‡ºç®¡ç†";
                adminBtn.classList.add('logged-in');
                exportBtn.style.display = "block";
                refreshMap();
            }
        } else {
            isAdmin = false;
            adminBtn.innerText = "ğŸ”“ ç®¡ç†å“¡ç™»å…¥";
            adminBtn.classList.remove('logged-in');
            exportBtn.style.display = "none";
            refreshMap();
        }
    };

    onValue(cloudRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            markersData = data.markers || [];
            guildHistory = data.guilds || [];
            refreshMap();
            updateDropdown();
            updateStats();
        }
    });

    function refreshMap() {
        markerInstances.forEach(m => map.removeLayer(m));
        markerInstances = [];
        markersData.forEach((d, i) => renderMarker(d, i));
    }

    function renderMarker(d, i) {
        const today = new Date().toISOString().split('T')[0];
        const isToday = (d.date === today);
        const displayName = d.guild ? d.guild.slice(0, 2) : '?';
        
        const icon = L.divIcon({
            className: `custom-marker ${d.color} ${isToday ? 'today-pulse' : ''}`,
            html: `<span>${displayName}</span>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18] // æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶éŒ¨é»ç‚ºä¸­å¿ƒ [å¯¬/2, é«˜/2]
        });
        
        const m = L.marker(d.latlng, { icon, draggable: isAdmin }).addTo(map);
        
        m.on('click', (e) => { 
            L.DomEvent.stopPropagation(e); 
            if (isAdmin) openForm(e.target.getLatLng(), i); 
            else {
                L.popup().setLatLng(e.target.getLatLng())
                    .setContent(`<b>${d.city}</b><br>å…¬æœƒï¼š${d.guild || 'ç„¡'}<br>æ—¥æœŸï¼š${d.date || 'æœªå®š'}`)
                    .openOn(map);
            }
        });

        m.on('dragend', () => { 
            if (isAdmin) { markersData[i].latlng = m.getLatLng(); pushToCloud(); }
        });
        markerInstances[i] = m;
    }

    // (æ­¤è™•çœç•¥ openForm, updateStats ç­‰å‡½æ•¸ï¼Œä»£ç¢¼é‚è¼¯åŒå‰ï¼Œç¢ºä¿åŠŸèƒ½å®Œæ•´)
    // ... åŸæœ‰åŠŸèƒ½å‡½æ•¸ ...

    window.jumpToMarker = function(index) {
        const data = markersData[index];
        const marker = markerInstances[index];
        if (data && marker) {
            map.flyTo(data.latlng, 0.5, { duration: 1.2 });
            setTimeout(() => { marker.fire('click'); }, 1300);
        }
    };
    
    map.on('contextmenu', (e) => { if (isAdmin) openForm(e.latlng); });

    function pushToCloud() {
        if (!isAdmin) return;
        set(cloudRef, { markers: markersData, guilds: guildHistory });
    }

    // ... å…¶ä»– Dropdown èˆ‡ Export å‡½æ•¸ ...
    function updateDropdown() {
        const sel = document.getElementById('guild-filter');
        const current = sel.value;
        const guilds = [...new Set(markersData.map(m => m.guild).filter(g => g))];
        let options = '<option value="">é¸æ“‡å…¬æœƒ...</option>';
        guilds.forEach(g => { options += `<option value="${g}" ${g === current ? 'selected' : ''}>${g}</option>`; });
        sel.innerHTML = options;
    }

    function updateStats() {
        const guild = document.getElementById('guild-filter').value;
        const content = document.getElementById('stat-content');
        if (!guild) return;
        let mine = markersData.map((m, originalIdx) => ({...m, originalIdx})).filter(m => m.guild === guild);
        mine.sort((a, b) => (new Date(a.date) - new Date(b.date)));
        let html = ''; let total = 0;
        mine.forEach(m => {
            html += `<div style="padding:5px; border-bottom:1px solid #ccc; cursor:pointer;" onclick="jumpToMarker(${m.originalIdx})">
                        ğŸ° <b>${m.city}</b> (Lv.${m.level}) <span style="float:right">${m.score}</span><br>
                        <small>${m.date || 'æœªå®š'}</small>
                     </div>`;
            total += m.score;
        });
        html += `<div style="margin-top:10px; color:red;"><b>ç¸½åˆ†: ${total}</b></div>`;
        content.innerHTML = html;
    }
    document.getElementById('guild-filter').onchange = updateStats;
</script>
</body>
</html>
