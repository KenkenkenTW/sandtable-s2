<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v6.1 - è¡Œè»è¨ˆç®—ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #1a1a1a; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        
        /* åŸºç¤æ¨™è¨˜ */
        .custom-marker { 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid black; border-radius: 50%; 
            color: black; font-weight: bold; font-size: 13px; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center;
            transform-origin: center !important;
        }
        
        .bg-pink { background-color: #ff69b4 !important; }
        .bg-blue { background-color: #87ceeb !important; }
        .bg-green { background-color: #00BB00 !important; }
        .bg-grey { background-color: #8E8E8E !important; }
        .bg-white { background-color: #E0E0E0 !important; }
        .bg-gold { background-color: #ffd700 !important; }
        .bg-purple { background-color: #BE77FF !important; }
        .bg-brown { background-color: #8b4513 !important; color: white !important; }
      
        /* ç‰¹æ•ˆèˆ‡ç‹€æ…‹ (ä¿ç•™åŸæœ¬é‚è¼¯) */
        .highlight-marker { width: 48px !important; height: 48px !important; margin-left: -24px !important; margin-top: -24px !important; z-index: 999 !important; border: 3px solid gold !important; box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8) !important; transition: all 0.3s ease; }
        @keyframes pulse-red { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        .today-active { z-index: 1000 !important; border: 3px solid red !important; }
        .today-active:after { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid red; animation: pulse-red 2s infinite; pointer-events: none; box-sizing: border-box; }

        /* UI é¢æ¿ - å·¦å´ */
        #stat-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 260px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        
        /* UI é¢æ¿ - å³å´è¡Œè»è¨ˆç®—å™¨ */
        #calc-panel { position: absolute; top: 60px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; width: 220px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); border-top: 5px solid #c53030; }
        .calc-title { margin: 0 0 10px 0; font-size: 16px; color: #333; display: flex; align-items: center; gap: 5px; }
        .calc-group { margin-bottom: 10px; }
        .calc-group label { display: block; font-size: 12px; color: #666; margin-bottom: 3px; }
        .calc-inputs { display: flex; gap: 5px; }
        .calc-inputs input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        #btn-calculate { width: 100%; padding: 8px; background: #c53030; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        #calc-res { margin-top: 12px; padding: 10px; background: #fff5f5; border-radius: 4px; border: 1px dashed #feb2b2; font-size: 13px; display: none; }

        .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 5px; }
        .toolbar button { padding: 8px 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #admin-btn { background: #d32f2f; }
        
        .hint { position: absolute; bottom: 15px; left: 15px; z-index: 1000; color: white; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<div id="stat-panel">
    <h3 style="margin-top:0;">å…¬æœƒå‹¢åŠ›æ’è¡Œ</h3>
    <select id="guild-filter" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;">
        <option value="">è¨ˆç®—ç©åˆ†ä¸­...</option>
    </select>
    <div id="stat-content">è«‹é¸æ“‡å…¬æœƒæŸ¥çœ‹è©³æƒ…</div>
    <div style="color: #4caf50; font-size: 10px; margin-top: 5px; text-align: right;" id="status-text">â— é›²ç«¯é€£ç·šä¸­</div>
</div>

<div id="calc-panel">
    <h4 class="calc-title">ğŸ¹ è¡Œè»æ™‚é–“è¨ˆç®—</h4>
    <div class="calc-group">
        <label>èµ·é»åº§æ¨™ (X, Y)</label>
        <div class="calc-inputs">
            <input type="number" id="x1" placeholder="X1">
            <input type="number" id="y1" placeholder="Y1">
        </div>
    </div>
    <div class="calc-group">
        <label>çµ‚é»åº§æ¨™ (X, Y)</label>
        <div class="calc-inputs">
            <input type="number" id="x2" placeholder="X2">
            <input type="number" id="y2" placeholder="Y2">
        </div>
    </div>
    <button id="btn-calculate">é–‹å§‹è¨ˆç®—</button>
    <div id="calc-res"></div>
</div>

<div class="toolbar">
    <button id="admin-btn">ğŸ”“ ç®¡ç†å“¡ç™»å…¥</button>
    <button id="export-btn" style="display:none;">ğŸ’¾ å‚™ä»½æ•¸æ“š</button>
</div>

<div class="hint">ç´…è‰²é–ƒçˆï¼šä»Šæ—¥é–‹æ”¾ | æ©˜è‰²é–ƒçˆï¼šä¸‹æ¬¡é å‘Š</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const cloudRef = ref(db, 'war_map_data');

    let isAdmin = false;
    let markersData = [];
    let markerInstances = [];

    // --- åœ°åœ–åˆå§‹åŒ– ---
    const imgUrl = 'https://drive.google.com/thumbnail?id=1MK2MEVjV1uaiDsTNigi5oUEyAJusPpuN&sz=w2973';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
    const bounds = [[0, 0], [2973, 2978]]; 
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // --- è¡Œè»è¨ˆç®—é‚è¼¯ ---
    document.getElementById('btn-calculate').onclick = () => {
        const x1 = parseInt(document.getElementById('x1').value);
        const y1 = parseInt(document.getElementById('y1').value);
        const x2 = parseInt(document.getElementById('x2').value);
        const y2 = parseInt(document.getElementById('y2').value);

        if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) {
            alert("è«‹å®Œæ•´è¼¸å…¥èµ·é»èˆ‡çµ‚é»åº§æ¨™");
            return;
        }

        // å…¬å¼: ABS(x1-x2) + ABS(y1-y2) - 1
        const distance = Math.abs(x1 - x2) + Math.abs(y1 - y2) - 1;
        const finalDist = distance < 0 ? 0 : distance; // é é˜²è·é›¢ç‚ºè² 
        const totalSeconds = finalDist * 4;

        // è½‰æ›ç‚º hh:mm:ss
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        const timeStr = [h, m, s].map(v => String(v).padStart(2, '0')).join(':');

        const resDiv = document.getElementById('calc-res');
        resDiv.style.display = 'block';
        resDiv.innerHTML = `
            ç¸½è·é›¢ï¼š<b>${finalDist}</b> æ ¼<br>
            é è¨ˆè€—æ™‚ï¼š<b style="color:#c53030; font-size:16px;">${timeStr}</b>
        `;
    };

    // --- Firebase & åŸæœ‰åœ°åœ–é‚è¼¯ (ç¸®æ¸›é‡è¤‡éƒ¨åˆ†ï¼Œä¿æŒåŠŸèƒ½) ---
    onValue(cloudRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            markersData = data.markers || [];
            refreshMap();
            updateDropdown();
            document.getElementById('status-text').innerText = "â— é›²ç«¯å·²åŒæ­¥";
        }
    });

    function refreshMap() {
        markerInstances.forEach(m => m && map.removeLayer(m));
        markerInstances = [];
        markersData.forEach((d, i) => {
            const icon = L.divIcon({
                className: `custom-marker ${d.color}`,
                html: `<span>${d.guild ? d.guild.slice(0, 2) : '?'}</span>`,
                iconSize: [34, 34],
                iconAnchor: [17, 17]
            });
            const m = L.marker(d.latlng, { icon }).addTo(map);
            m.on('click', () => {
                // é¡¯ç¤ºè³‡è¨Šå½ˆçª— (ä¿æŒæ‚¨åŸæœ¬çš„è¨­è¨ˆ)
                L.popup({ minWidth: 400 }).setLatLng(d.latlng).setContent(`
                    <div style="padding:10px;">
                        <h3>${d.city} (Lv.${d.level})</h3>
                        <p>ä½”é ˜ï¼š${d.guild || 'ç„¡'}</p>
                        <p style="font-size:12px; color:#666;">é»æ“Šåº§æ¨™å¯å¿«é€Ÿå¡«å…¥è¨ˆç®—å™¨(é–‹ç™¼ä¸­)</p>
                    </div>
                `).openOn(map);
            });
            markerInstances[i] = m;
        });
    }

    // (æ­¤è™•çœç•¥å…¶é¤˜æ‚¨åŸæœ¬çš„ updateStats, updateDropdown, pushToCloud ç­‰å‡½æ•¸ï¼Œè«‹ç¢ºä¿ä¿ç•™åœ¨æ‚¨çš„æ–‡ä»¶ä¸­)
    // ç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•é‚è¼¯...
    document.getElementById('admin-btn').onclick = () => {
        const pass = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
        if (pass === "wu0 u86") {
            isAdmin = true;
            document.getElementById('admin-btn').innerText = "ğŸ”’ é€€å‡ºç®¡ç†";
            document.getElementById('export-btn').style.display = "block";
        }
    };
</script>
</body>
</html>
