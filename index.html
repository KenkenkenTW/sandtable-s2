<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v4.8 - è‡ªå‹•å®šä½è·³è½‰ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #222; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; cursor: crosshair; }
        
        .custom-marker { display: flex; align-items: center; justify-content: center; border: 2px solid black; border-radius: 50%; color: black; font-weight: bold; font-size: 13px; box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center; }
        .bg-pink { background-color: #ff69b4 !important; }
        .bg-blue { background-color: #87ceeb !important; }
        .bg-green { background-color: #90ee90 !important; }
        .bg-gold { background-color: #ffd700 !important; }
        .bg-silver { background-color: #c0c0c0 !important; }
        .bg-brown { background-color: #8b4513 !important; color: white !important; }

        #stat-panel { position: absolute; top: 10px; left: 50px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; width: 260px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto; }
        #stat-panel h3 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        
        /* çµ±è¨ˆé …é»æ“Šæ¨£å¼ */
        .stat-item { font-size: 13px; margin: 5px 0; padding: 8px 5px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background 0.2s; }
        .stat-item:hover { background: rgba(0,0,0,0.05); }
        .city-link { color: #1a73e8; font-weight: bold; text-decoration: underline; }
        .stat-date { display: block; font-size: 10px; color: #666; margin-top: 2px; }
        
        .total-score { font-weight: bold; color: #d32f2f; font-size: 15px; margin-top: 10px; padding-top: 5px; border-top: 2px solid #d32f2f; }

        .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 5px; }
        .toolbar button { padding: 8px 12px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; font-weight: bold; }

        .popup-form { display: flex; flex-direction: column; gap: 8px; min-width: 220px; padding: 5px; }
        .popup-form label { font-size: 12px; color: #333; font-weight: bold; }
        .popup-form input, .popup-form select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-save { background: #2e7d32; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; flex: 2; font-weight: bold; }
        .btn-del { background: #d32f2f; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; flex: 1; }
        
        .hint { position: absolute; bottom: 15px; left: 15px; z-index: 1000; color: white; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
        .sync-status { color: #4caf50; font-size: 10px; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

<div id="stat-panel">
    <h3>å…¬æœƒå‹¢åŠ›çµ±è¨ˆ</h3>
    <select id="guild-filter" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
        <option value="">é¸æ“‡å…¬æœƒ...</option>
    </select>
    <div id="stat-content">ç­‰å¾…è³‡æ–™ä¸­...</div>
    <div class="sync-status" id="status-text">â— é›²ç«¯é€£ç·šä¸­</div>
</div>

<div class="toolbar">
    <button id="export-btn">ğŸ’¾ å‚™ä»½æ•¸æ“š</button>
</div>

<div class="hint">æ“ä½œï¼š[å³éµ] æ–°å¢æ¨™è¨˜ | [é»æ“Šçµ±è¨ˆåŸæ± ] å¿«é€Ÿè·³è½‰å®šä½</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable",
        storageBucket: "revelation-sandtable.firebasestorage.app",
        messagingSenderId: "572907835922",
        appId: "1:572907835922:web:505556c77ea56cfac83ecb",
        measurementId: "G-3K2YS695G9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const cloudRef = ref(db, 'war_map_data');

    let markersData = [];
    let guildHistory = [];
    let markerInstances = []; // å„²å­˜åœ°åœ–æ¨™è¨˜å¯¦é«”ä»¥ä¾›è·³è½‰

    const imgUrl = 'é–‹å­£.png';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
    const bounds = [[0, 0], [2973, 2978]];
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    function pushToCloud() {
        set(cloudRef, { markers: markersData, guilds: guildHistory });
        document.getElementById('status-text').innerText = "â— æ­£åœ¨åŒæ­¥...";
    }

    onValue(cloudRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            markersData = data.markers || [];
            guildHistory = data.guilds || [];
            refreshMap();
            updateDropdown();
            updateStats();
            document.getElementById('status-text').innerText = "â— é›²ç«¯å·²åŒæ­¥";
        }
    });

    function refreshMap() {
        // æ¸…é™¤èˆŠæ¨™è¨˜
        markerInstances.forEach(m => map.removeLayer(m));
        markerInstances = [];
        
        markersData.forEach((d, i) => renderMarker(d, i));
    }

    function renderMarker(d, i) {
        const displayName = d.guild ? d.guild.slice(0, 2) : '?';
        const icon = L.divIcon({
            className: `custom-marker ${d.color}`,
            html: `<span>${displayName}</span>`,
            iconSize: [36, 36]
        });
        const m = L.marker(d.latlng, { icon, draggable: true }).addTo(map);
        
        m.on('click', (e) => { 
            L.DomEvent.stopPropagation(e); 
            openForm(e.target.getLatLng(), i); 
        });

        m.on('dragend', () => { 
            markersData[i].latlng = m.getLatLng(); 
            pushToCloud(); 
        });

        markerInstances[i] = m; // å­˜å…¥é™£åˆ—ï¼Œç´¢å¼•éœ€èˆ‡ markersData å°é½Š
    }

    // æä¾›çµ¦çµ±è¨ˆé¢æ¿é»æ“Šçš„è·³è½‰å‡½æ•¸
    window.jumpToMarker = function(index) {
        const data = markersData[index];
        const marker = markerInstances[index];
        if (data && marker) {
            map.flyTo(data.latlng, 1, { duration: 1.5 }); // è·³è½‰åˆ°è©²åº§æ¨™ï¼Œç¸®æ”¾ç­‰ç´šç‚º 1
            setTimeout(() => {
                marker.fire('click'); // åˆ°é”å¾Œè‡ªå‹•è§¸ç™¼é»æ“Šï¼ˆé–‹å•Ÿç·¨è¼¯å½ˆçª—ï¼‰
            }, 1600);
        }
    };

    map.on('contextmenu', (e) => { openForm(e.latlng); });

    function openForm(latlng, index = null) {
        const isEdit = index !== null;
        const d = isEdit ? markersData[index] : { city: '', guild: '', color: 'bg-pink', level: 1, date: '' };
        const historyOptions = guildHistory.map(g => `<option value="${g}">`).join('');

        const html = `
            <div class="popup-form">
                <strong>${isEdit ? 'ç·¨è¼¯åŸæ± ' : 'æ–°å¢æ¨™è¨˜'}</strong>
                <label>åŸæ± åç¨±</label>
                <input type="text" id="f_city" value="${d.city}" placeholder="è¼¸å…¥åç¨±">
                <label>æ—¥æœŸ</label>
                <input type="date" id="f_date" value="${d.date || ''}">
                <label>åŸæ± ç­‰ç´š (Lv)</label>
                <input type="number" id="f_level" value="${d.level}" min="1">
                <label>ä½”é ˜å…¬æœƒ</label>
                <input type="text" id="f_guild" list="guild_list" value="${d.guild}">
                <datalist id="guild_list">${historyOptions}</datalist>
                <label>é¡¯ç¤ºé¡è‰²</label>
                <select id="f_color">
                    <option value="bg-pink" ${d.color==='bg-pink'?'selected':''}>å°æœ</option>
                    <option value="bg-blue" ${d.color==='bg-blue'?'selected':''}>éŸ“æœ</option>
                    <option value="bg-green" ${d.color==='bg-green'?'selected':''}>æ—¥æœ</option>
                    <option value="bg-grey" ${d.color==='bg-green'?'selected':''}>ç©ºåŸ</option>
                    <option value="bg-white" ${d.color==='bg-green'?'selected':''}>æœªé–‹æ”¾</option>
                    <option value="bg-gold" ${d.color==='bg-gold'?'selected':''}>é‡‘è‰²</option>
                    <option value="bg-silver" ${d.color==='bg-silver'?'selected':''}>éŠ€è‰²</option>
                    <option value="bg-brown" ${d.color==='bg-brown'?'selected':''}>ç‹—è‰²</option>
                </select>
                <div class="btn-group">
                    <button class="btn-save" id="pop-save">å„²å­˜åŒæ­¥</button>
                    ${isEdit ? `<button class="btn-del" id="pop-del">åˆªé™¤</button>` : ''}
                </div>
            </div>`;
            
        L.popup({ minWidth: 230 }).setLatLng(latlng).setContent(html).openOn(map);

        document.getElementById('pop-save').onclick = () => {
            const guild = document.getElementById('f_guild').value;
            const level = parseInt(document.getElementById('f_level').value) || 1;
            const newData = {
                city: document.getElementById('f_city').value || 'æœªå‘½å',
                date: document.getElementById('f_date').value,
                level: level,
                score: level * 20,
                guild: guild,
                color: document.getElementById('f_color').value,
                latlng: { lat: latlng.lat, lng: latlng.lng }
            };
            if (guild && !guildHistory.includes(guild)) guildHistory.push(guild);
            if (isEdit) markersData[index] = newData;
            else markersData.push(newData);
            pushToCloud();
            map.closePopup();
        };

        if(isEdit) {
            document.getElementById('pop-del').onclick = () => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                    markersData.splice(index, 1);
                    pushToCloud();
                    map.closePopup();
                }
            };
        }
    }

    function updateStats() {
        const guild = document.getElementById('guild-filter').value;
        const content = document.getElementById('stat-content');
        if (!guild) { content.innerHTML = "è«‹å…ˆé¸æ“‡å…¬æœƒ"; return; }
        
        // æ‰¾å‡ºè©²å…¬æœƒçš„æ‰€æœ‰æ¨™è¨˜åŠå…¶åŸå§‹ç´¢å¼•
        const mine = markersData.map((m, originalIdx) => ({...m, originalIdx}))
                                .filter(m => m.guild === guild);

        if (mine.length === 0) {
            content.innerHTML = `å…¬æœƒ [${guild}] ç›®å‰ç„¡é ˜åœ°`;
            return;
        }

        let html = ''; let total = 0;
        mine.forEach(m => {
            html += `<div class="stat-item" onclick="jumpToMarker(${m.originalIdx})">
                        ğŸ° <span class="city-link">${m.city}</span> (Lv.${m.level}) <span style="float:right">${m.score}</span>
                        ${m.date ? `<span class="stat-date">ğŸ“… æ—¥æœŸ: ${m.date}</span>` : ''}
                     </div>`;
            total += m.score;
        });
        html += `<div class="total-score">ç¸½ç©åˆ† <span style="float:right">${total}</span></div>`;
        content.innerHTML = html;
    }

    function updateDropdown() {
        const sel = document.getElementById('guild-filter');
        const current = sel.value;
        const guilds = [...new Set(markersData.map(m => m.guild).filter(g => g))];
        let options = '<option value="">é¸æ“‡å…¬æœƒ...</option>';
        guilds.forEach(g => { options += `<option value="${g}" ${g === current ? 'selected' : ''}>${g}</option>`; });
        sel.innerHTML = options;
    }

    document.getElementById('guild-filter').onchange = updateStats;

    document.getElementById('export-btn').onclick = () => {
        const data = { markers: markersData, guilds: guildHistory };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æ²™ç›¤å‚™ä»½_${new Date().toLocaleDateString()}.json`;
        a.click();
    };
</script>
</body>
</html>
