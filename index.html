<!DOCTYPE html>
<html lang="zh-TW"><head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯æˆ°ç•¥æ²™ç›¤ v4.3 - ä¿®æ­£çµ±è¨ˆèˆ‡ç‰ˆé¢</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>body,
html {
    margin: 0px;
    padding: 0px;
    height: 100%;
    background: rgb(34, 34, 34);
    font-family: "Microsoft JhengHei", sans-serif;
    overflow: hidden;
}
#map {
    height: 100vh;
    width: 100%;
    cursor: crosshair;
}
.custom-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid black;
    border-radius: 50%;
    color: black;
    font-weight: bold;
    font-size: 16px;
    box-shadow: rgba(0, 0, 0, 0.5) 0px 0px 5px;
}
.bg-pink {
    background-color: rgb(255, 105, 180) !important;
}
.bg-blue {
    background-color: rgb(135, 206, 235) !important;
}
.bg-green {
    background-color: rgb(144, 238, 144) !important;
}
#stat-panel {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.9);
    padding: 15px;
    border-radius: 8px;
    width: 240px;
    box-shadow: rgba(0, 0, 0, 0.3) 0px 2px 10px;
    max-height: 80vh;
    overflow-y: auto;
}
#stat-panel h3 {
    margin: 0px 0px 10px;
    font-size: 16px;
    border-bottom: 1px solid rgb(204, 204, 204);
    padding-bottom: 5px;
}
.stat-item {
    font-size: 13px;
    margin: 5px 0px;
    padding: 3px;
    border-bottom: 1px solid rgb(238, 238, 238);
}
.total-score {
    font-weight: bold;
    color: rgb(211, 47, 47);
    font-size: 15px;
    margin-top: 10px;
    padding-top: 5px;
    border-top: 2px solid rgb(211, 47, 47);
}
.toolbar {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    display: flex;
    gap: 5px;
}
.toolbar button {
    padding: 8px 12px;
    cursor: pointer;
    background: rgb(51, 51, 51);
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: bold;
}
.popup-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 220px;
    padding: 5px;
}
.popup-form label {
    font-size: 12px;
    color: rgb(51, 51, 51);
    font-weight: bold;
}
.popup-form input,
.popup-form select {
    padding: 8px;
    border: 1px solid rgb(204, 204, 204);
    border-radius: 4px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
}
.row {
    display: flex;
    gap: 5px;
    align-items: center;
}
.btn-group {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.btn-save {
    background: rgb(46, 125, 50);
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    border-radius: 4px;
    flex: 2 1 0%;
    font-weight: bold;
}
.btn-del {
    background: rgb(211, 47, 47);
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    border-radius: 4px;
    flex: 1 1 0%;
}
.hint {
    position: absolute;
    bottom: 15px;
    left: 15px;
    z-index: 1000;
    color: white;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    pointer-events: none;
}
.sync-status {
    color: rgb(76, 175, 80);
    font-size: 10px;
    margin-top: 5px;
    text-align: right;
}</style>
<style>#pagedeck { overflow: hidden !important; }</style></head>
<body>

<div id="stat-panel">
    <h3>å…¬æœƒå‹¢åŠ›çµ±è¨ˆ</h3>
    <select id="guild-filter" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
        <option value="">é¸æ“‡å…¬æœƒ...</option>
    </select>
    <div id="stat-content">ç­‰å¾…è³‡æ–™ä¸­...</div>
    <div class="sync-status" id="status-text">â— é›²ç«¯å·²é€£ç·š</div>
</div>

<div class="toolbar">
    <button id="undo-btn" style="background: #f57c00;">â†© æ’¤éŠ·</button>
    <button id="export-btn">ğŸ’¾ å‚™ä»½</button>
</div>

<div class="hint">æ“ä½œï¼š[å³éµ] æ–°å¢æ¨™è¨˜ | [Alt + å·¦éµæ‹–æ›³] ç•«ç®­é ­ | [é»æ“Š] ç·¨è¼¯æˆ–åˆªé™¤</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-arrowheads@1.4.0/dist/leaflet-arrowheads.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-q2akyvasJ9XfccsNPrXWoxWOWlRq2yQ",
        authDomain: "revelation-sandtable.firebaseapp.com",
        databaseURL: "https://revelation-sandtable-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "revelation-sandtable",
        storageBucket: "revelation-sandtable.firebasestorage.app",
        messagingSenderId: "572907835922",
        appId: "1:572907835922:web:505556c77ea56cfac83ecb",
        measurementId: "G-3K2YS695G9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const cloudRef = ref(db, 'war_map_data');

    let markersData = [];
    let linesData = [];
    let guildHistory = [];
    let actionStack = [];

    const imgUrl = 'https://drive.google.com/thumbnail?id=13VlgvIDNeQ11dQ-OsslgmGdi6gIN5ZG1&sz=w2973';
    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 2 });
    const bounds = [[0, 0], [2000, 2000]];
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    function pushToCloud() {
        set(cloudRef, {
            markers: markersData,
            lines: linesData,
            guilds: guildHistory,
            stack: actionStack
        });
        document.getElementById('status-text').innerText = "â— æ­£åœ¨åŒæ­¥...";
    }

    onValue(cloudRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            markersData = data.markers || [];
            linesData = data.lines || [];
            guildHistory = data.guilds || [];
            actionStack = data.stack || [];
            refreshMap();
            updateGuildDropdown();
            updateStatsDisplay(); // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            document.getElementById('status-text').innerText = "â— é›²ç«¯å·²åŒæ­¥";
        }
    });

    function refreshMap() {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                if (!(layer instanceof L.ImageOverlay)) map.removeLayer(layer);
            }
        });
        markersData.forEach((d, i) => renderMarker(d, i));
        linesData.forEach((d, i) => renderLine(d, i));
    }

    function renderMarker(d, i) {
        const icon = L.divIcon({
            className: `custom-marker ${d.color}`,
            html: `<span>${d.guild ? d.guild[0] : '?'}</span>`,
            iconSize: [32, 32]
        });
        const m = L.marker(d.latlng, { icon, draggable: true }).addTo(map);
        m.on('click', () => window.showPopup(m.getLatLng(), i));
        m.on('dragend', () => {
            markersData[i].latlng = m.getLatLng();
            pushToCloud();
        });
    }

    function renderLine(pts, i) {
        const line = L.polyline(pts, { color: 'red', weight: 4, opacity: 0.8 }).arrowheads({size: '15px'}).addTo(map);
        line.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if(confirm('åˆªé™¤æ­¤æ”»æ“Šç®­é ­ï¼Ÿ')) {
                linesData.splice(i, 1);
                pushToCloud();
            }
        });
    }

    // --- å½ˆçª—åŠŸèƒ½ä¿®æ­£ ---
    window.showPopup = function(latlng, index = null) {
        const isEdit = index !== null;
        const d = isEdit ? markersData[index] : { city: '', guild: '', color: 'bg-pink', level: 1 };
        const historyOptions = guildHistory.map(g => `<option value="${g}">`).join('');

        const html = `
            <div class="popup-form">
                <strong>${isEdit ? 'ç·¨è¼¯åŸæ± ' : 'æ–°å¢æ¨™è¨˜'}</strong>
                <label>åŸæ± åç¨±</label>
                <input type="text" id="f_city" value="${d.city}" placeholder="ä¾‹å¦‚: è¥„é™½">
                
                <label>åŸæ± ç­‰ç´š (Lv)</label>
                <input type="number" id="f_level" value="${d.level}" min="1" max="10">
                
                <label>ä½”é ˜å…¬æœƒ</label>
                <input type="text" id="f_guild" list="guild_list" value="${d.guild}" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                <datalist id="guild_list">${historyOptions}</datalist>
                
                <label>æ¨™è¨˜é¡è‰²</label>
                <select id="f_color">
                    <option value="bg-pink" ${d.color==='bg-pink'?'selected':''}>æ¡ƒç´… (æ•µæ–¹)</option>
                    <option value="bg-blue" ${d.color==='bg-blue'?'selected':''}>è—è‰² (å‹æ–¹)</option>
                    <option value="bg-green" ${d.color==='bg-green'?'selected':''}>æ·ºç¶  (ç›Ÿå‹)</option>
                </select>
                
                <div class="btn-group">
                    <button class="btn-save" id="save-btn">å„²å­˜åŒæ­¥</button>
                    ${isEdit ? `<button class="btn-del" id="del-btn">åˆªé™¤</button>` : ''}
                </div>
            </div>`;
            
        L.popup({ minWidth: 230 }).setLatLng(latlng).setContent(html).openOn(map);

        document.getElementById('save-btn').onclick = () => {
            const guild = document.getElementById('f_guild').value;
            const level = parseInt(document.getElementById('f_level').value) || 1;
            const newData = {
                city: document.getElementById('f_city').value || 'æœªå‘½å',
                level: level,
                score: level * 20, // å‡è¨­ 1 ç´š 20 åˆ†
                guild: guild,
                color: document.getElementById('f_color').value,
                latlng: { lat: latlng.lat, lng: latlng.lng }
            };
            if (guild && !guildHistory.includes(guild)) guildHistory.push(guild);
            if (isEdit) markersData[index] = newData;
            else { markersData.push(newData); actionStack.push('marker'); }
            pushToCloud();
            map.closePopup();
        };

        if(isEdit) {
            document.getElementById('del-btn').onclick = () => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                    markersData.splice(index, 1);
                    pushToCloud();
                    map.closePopup();
                }
            };
        }
    };

    // --- çµ±è¨ˆåŠŸèƒ½ä¿®æ­£ ---
    window.updateStatsDisplay = () => {
        const filterEl = document.getElementById('guild-filter');
        const guild = filterEl.value;
        const content = document.getElementById('stat-content');
        
        if (!guild) {
            content.innerHTML = "è«‹å¾ä¸Šæ–¹é¸å–®é¸æ“‡å…¬æœƒ";
            return;
        }

        const mine = markersData.filter(m => m.guild === guild);
        if (mine.length === 0) {
            content.innerHTML = `å…¬æœƒ [${guild}] å°šæœªä½”é ˜åŸæ± `;
            return;
        }

        let html = '';
        let total = 0;
        mine.forEach(m => {
            html += `<div class="stat-item">ğŸ° ${m.city} <small>(Lv.${m.level})</small> <span style="float:right">${m.score}</span></div>`;
            total += m.score;
        });
        html += `<div class="total-score">ç¸½è¨ˆç©åˆ† <span style="float:right">${total}</span></div>`;
        content.innerHTML = html;
    };

    function updateGuildDropdown() {
        const sel = document.getElementById('guild-filter');
        const current = sel.value;
        const guilds = [...new Set(markersData.map(m => m.guild).filter(g => g))];
        
        // ä¿ç•™ã€Œé¸æ“‡å…¬æœƒã€</script></body></html>
